#!/bin/bash
set -e

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Helper functions
log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }

TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_DIR="$HOME/.config-backup-$TIMESTAMP"

main() {
    log_info "üíæ Backing up current configurations..."

    # Create backup directory
    mkdir -p "$BACKUP_DIR"

    # Export current tool versions
    export_tool_versions

    # Export VS Code extensions
    export_vscode_extensions

    # Export Homebrew packages
    export_homebrew_packages

    # Copy important configs
    backup_configs

    log_success "üéâ Backup complete: $BACKUP_DIR"
}

export_tool_versions() {
    log_info "üìã Exporting tool versions..."

    if command -v mise >/dev/null 2>&1; then
        mise list > "$BACKUP_DIR/mise-tools.txt"
        log_success "‚úÖ mise tools exported"
    fi

    if command -v node >/dev/null 2>&1; then
        node --version > "$BACKUP_DIR/node-version.txt"
        npm list -g --depth=0 > "$BACKUP_DIR/npm-global-packages.txt" 2>/dev/null || true
    fi

    if command -v python >/dev/null 2>&1; then
        python --version > "$BACKUP_DIR/python-version.txt"
        pip list > "$BACKUP_DIR/pip-packages.txt" 2>/dev/null || true
    fi
}

export_vscode_extensions() {
    if command -v code >/dev/null 2>&1; then
        log_info "üîå Exporting VS Code extensions..."
        code --list-extensions > "$BACKUP_DIR/vscode-extensions.txt"
        log_success "‚úÖ VS Code extensions exported"
    fi
}

export_homebrew_packages() {
    if command -v brew >/dev/null 2>&1; then
        log_info "üç∫ Exporting Homebrew packages..."
        brew list > "$BACKUP_DIR/brew-installed.txt"
        brew list --cask > "$BACKUP_DIR/brew-casks.txt"
        brew bundle dump --file="$BACKUP_DIR/Brewfile-backup"
        log_success "‚úÖ Homebrew packages exported"
    fi
}

backup_configs() {
    log_info "üìÅ Backing up configuration files..."

    # Copy key config files
    [[ -f "$HOME/.zshrc" ]] && cp "$HOME/.zshrc" "$BACKUP_DIR/"
    [[ -f "$HOME/.gitconfig" ]] && cp "$HOME/.gitconfig" "$BACKUP_DIR/"
    [[ -f "$HOME/.ssh/config" ]] && cp "$HOME/.ssh/config" "$BACKUP_DIR/"

    # Copy config directories
    [[ -d "$HOME/.config/git" ]] && cp -r "$HOME/.config/git" "$BACKUP_DIR/"
    [[ -d "$HOME/.config/mise" ]] && cp -r "$HOME/.config/mise" "$BACKUP_DIR/"
    [[ -d "$HOME/.config/nvim" ]] && cp -r "$HOME/.config/nvim" "$BACKUP_DIR/"
    [[ -d "$HOME/.config/tmux" ]] && cp -r "$HOME/.config/tmux" "$BACKUP_DIR/"

    log_success "‚úÖ Configuration files backed up"
}

# Run main function
main "$@"