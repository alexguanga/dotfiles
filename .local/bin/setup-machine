#!/bin/bash
set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Configuration
DOTFILES_REPO="${DOTFILES_REPO:-git@github.com:alexguanga/dotfiles.git}"
DOTFILES_DIR="$HOME/.dotfiles"

main() {
    log_info "ðŸš€ Setting up development environment..."

    # Check if we're on macOS
    if [[ "$OSTYPE" != "darwin"* ]]; then
        log_error "This script is designed for macOS. Exiting."
        exit 1
    fi

    # Install Homebrew if missing
    install_homebrew

    # Setup dotfiles repository
    setup_dotfiles

    # Install packages and tools
    install_packages

    # Setup SSH permissions
    setup_ssh_permissions

    # Configure shell
    configure_shell

    log_success "ðŸŽ‰ Setup complete! Your development environment is ready."
    log_info "ðŸ”„ Please restart your terminal or run 'source ~/.zshrc'"
}

install_homebrew() {
    if command -v brew >/dev/null 2>&1; then
        log_info "âœ… Homebrew already installed"
        return
    fi

    log_info "ðŸ“¦ Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Add Homebrew to PATH for Apple Silicon Macs
    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi

    log_success "âœ… Homebrew installed"
}

setup_dotfiles() {
    if [[ -d "$DOTFILES_DIR" ]]; then
        log_info "ðŸ“ Dotfiles directory already exists, pulling latest changes..."
        git --git-dir="$DOTFILES_DIR" --work-tree="$HOME" pull
        return
    fi

    log_info "ðŸ“¥ Cloning dotfiles repository..."

    # Clone bare repository
    git clone --bare "$DOTFILES_REPO" "$DOTFILES_DIR"

    # Setup dotfiles alias temporarily
    function dotfiles {
        git --git-dir="$DOTFILES_DIR" --work-tree="$HOME" "$@"
    }

    # Backup existing files
    log_info "ðŸ”„ Backing up existing dotfiles..."
    mkdir -p "$HOME/.dotfiles-backup"

    if dotfiles checkout 2>&1 | grep -E "would be overwritten|would be removed"; then
        log_warning "Some dotfiles already exist. Backing up conflicting files..."
        dotfiles checkout 2>&1 | egrep "\s+\." | awk {'print $1'} | xargs -I{} mv {} "$HOME/.dotfiles-backup/"
    fi

    # Checkout dotfiles
    dotfiles checkout
    dotfiles config --local status.showUntrackedFiles no

    log_success "âœ… Dotfiles configured"
}

install_packages() {
    log_info "ðŸ“¦ Installing Homebrew packages..."
    if [[ -f "$HOME/.Brewfile" ]]; then
        brew bundle --file="$HOME/.Brewfile"
        log_success "âœ… Homebrew packages installed"
    else
        log_warning "âš ï¸  No .Brewfile found, skipping package installation"
    fi

    log_info "ðŸ”§ Installing development tools with mise..."
    if command -v mise >/dev/null 2>&1; then
        mise install
        log_success "âœ… Development tools installed"
    else
        log_warning "âš ï¸  mise not found, skipping tool installation"
    fi
}

setup_ssh_permissions() {
    if [[ -f "$HOME/.ssh/config" ]]; then
        log_info "ðŸ” Setting SSH config permissions..."
        chmod 600 "$HOME/.ssh/config"
        log_success "âœ… SSH permissions configured"
    fi
}

configure_shell() {
    log_info "ðŸš Configuring shell environment..."

    # Source zsh configuration if it exists
    if [[ -f "$HOME/.zshrc" ]]; then
        # Check if we're already in zsh to avoid recursive sourcing
        if [[ "$SHELL" == */zsh ]]; then
            log_info "ðŸ”„ Zsh configuration will be loaded on next shell session"
        fi
        log_success "âœ… Shell configuration ready"
    fi

    # Install tmux plugins if tmux is available
    if command -v tmux >/dev/null 2>&1 && [[ -f "$HOME/.config/tmux/tmux.conf" ]]; then
        log_info "ðŸ–¥ï¸  Installing tmux plugins..."
        # This will install tpm if it doesn't exist
        git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm 2>/dev/null || true
        log_success "âœ… tmux plugins ready"
    fi
}

# Run main function
main "$@"